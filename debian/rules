#!/usr/bin/make -f
export DH_VERBOSE=1
IMAGE_NAME ?= rsdk-image

%:
	dh $@

override_dh_auto_build:
	@echo "Nothing to build at this stage"

override_dh_auto_test:
	@echo "Skipping tests during package build"


override_dh_auto_install:
	# Generate and stage images directly into the package dir so dh_prep won't wipe them
	pkgdir=$(CURDIR)/debian/rsdk-image; \
	arch=$$(dpkg --print-architecture); \
	dh_auto_install --destdir="$$pkgdir" || true; \
	imgdir=$$pkgdir/usr/share/rsdk-image/images/$$arch; \
	mkdir -p $$imgdir; \
	if command -v docker >/dev/null 2>&1; then \
	  echo "Building $(IMAGE_NAME) for current platform ..."; \
	  docker build -t $(IMAGE_NAME) . \
	    || { echo "ERROR: docker build failed" >&2; exit 1; }; \
	  docker save $(IMAGE_NAME) -o $$imgdir/image.tar \
	    || { echo "ERROR: docker save failed" >&2; exit 1; }; \
	else \
	  echo "ERROR: docker not available; install docker" >&2; \
	  exit 1; \
	fi
